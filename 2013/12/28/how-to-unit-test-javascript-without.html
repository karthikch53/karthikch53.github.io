<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>how to unit test javascript without setting your hair on fire? </title><link rel="stylesheet" type="text/css" href="/assets/main-light.css"></head>
<body>
    <div class="container"><header>
  <div class="menu">
    <ul><li><a href="/">/home</a></li><li><a href="/about/">/about</a></li></ul>
  </div>
</header>
<main>
      <b>how to unit test javascript without setting your hair on fire? </b>
<br>
<br>
<div dir="ltr" style="text-align: left;" trbidi="on">This code looks familiar? Most of us, at some point in time would have written javascript this way to do a simple login validation. Right?<br /><br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: .1em .1em .1em .8em; border: solid gray; overflow: auto; padding: .2em .6em; width: auto;"><table><tbody><tr><td><pre style="line-height: 125%; margin: 0;"> 1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17<br />18<br />19<br />20<br />21</pre></td><td><pre style="line-height: 125%; margin: 0;"><span style="color: #008800; font-weight: bold;">function</span> formSubmit(){<br />     <span style="color: #008800; font-weight: bold;">var</span> userName <span style="color: #333333;">=</span> $(<span style="background-color: #fff0f0;">"#userName"</span>).val();<br />    <span style="color: #008800; font-weight: bold;">var</span> password <span style="color: #333333;">=</span> $(<span style="background-color: #fff0f0;">"#password"</span>).val();<br /><br />    <span style="color: #008800; font-weight: bold;">if</span>(<span style="color: #333333;">!</span>isValid(userName,password)){<br />    <span style="color: #008800; font-weight: bold;">return</span> <span style="color: #008800; font-weight: bold;">false</span>;<br />    }<br /><br />    $.ajax({<br />        type<span style="color: #333333;">:</span> <span style="background-color: #fff0f0;">'POST'</span>,<br />        url<span style="color: #333333;">:</span> <span style="background-color: #fff0f0;">"login"</span>,<br />        dataType<span style="color: #333333;">:</span> <span style="background-color: #fff0f0;">'text'</span>,<br />        data <span style="color: #333333;">:</span> <span style="background-color: #fff0f0;">"username="</span><span style="color: #333333;">+</span>userName<span style="color: #333333;">+</span><span style="background-color: #fff0f0;">"&amp;password="</span><span style="color: #333333;">+</span>password,<br />        success<span style="color: #333333;">:</span> <span style="color: #008800; font-weight: bold;">function</span> (data) { <br />            alert(<span style="background-color: #fff0f0;">'Login Success'</span>);<br />        },<br />        error<span style="color: #333333;">:</span> <span style="color: #008800; font-weight: bold;">function</span>( xhr, err) {<br />            alert(<span style="background-color: #fff0f0;">'Login Failed.'</span><span style="color: #333333;">+</span> xhr.status);<br />        }<br />    });<br />}<br /></pre></td></tr></tbody></table></div><br />The real problem comes when we try to write unit tests for this kind of javascript. The issue is the code which is completely mixed with HTML and inline event handlers.<br />So what? Big Deal. Why not write test cases to test HTML dependencies and DOM manipulations?<br />Yeah! You could. But you would end up writing ONLY test cases rather than writing actual functions. <br /><br />How about we refactor the code so that it's testable?<br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: .1em .1em .1em .8em; border: solid gray; overflow: auto; padding: .2em .6em; width: auto;"><table><tbody><tr><td><pre style="line-height: 125%; margin: 0;"> 1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10<br />11<br />12<br />13</pre></td><td><pre style="line-height: 125%; margin: 0;"><span style="color: #008800; font-weight: bold;">function</span> formSubmit()<br />{<br />    <span style="color: #008800; font-weight: bold;">var</span> cred <span style="color: #333333;">=</span> readValuesFromUI(); <span style="color: #888888;">//separate out the function which reads values from ui.</span><br />    <span style="color: #008800; font-weight: bold;">var</span> val <span style="color: #333333;">=</span> validate(cred); <span style="color: #888888;">// separate out validations.</span><br />    <span style="color: #008800; font-weight: bold;">if</span>(val.isValid)<br />    {<br />        doLogin(cred); <span style="color: #888888;">// ajax call to server</span><br />    }<br />    <span style="color: #008800; font-weight: bold;">else</span><br />    {<br />        alert(<span style="background-color: #fff0f0;">'Invalid Credentials.'</span>);<br />    }<br />}<br /></pre></td></tr></tbody></table></div><br /><a href="http://pivotal.github.io/jasmine/">Jasmine Specs to the rescue</a><br />Jasmine - An automated test framework for Javascript.<br />Say you have a function which returns the sum of two numbers<br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: .1em .1em .1em .8em; border: solid gray; overflow: auto; padding: .2em .6em; width: auto;"><table><tbody><tr><td><pre style="line-height: 125%; margin: 0;"> 1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10</pre></td><td><pre style="line-height: 125%; margin: 0;"><span style="color: #008800; font-weight: bold;">function</span> sum(num1, num2){<br />    <span style="color: #008800; font-weight: bold;">return</span> num1 <span style="color: #333333;">+</span> num2;<br />}<br /><br />describe(<span style="background-color: #fff0f0;">"this is a suite which tests the function sum with various inputs"</span>, <span style="color: #008800; font-weight: bold;">function</span>() {<br />    it(<span style="background-color: #fff0f0;">"this is a spec which tests +ve scenario"</span>, <span style="color: #008800; font-weight: bold;">function</span>() {<br />    <span style="color: #008800; font-weight: bold;">var</span> s <span style="color: #333333;">=</span> sum(<span style="color: #0000dd; font-weight: bold;">1</span>,<span style="color: #0000dd; font-weight: bold;">2</span>);       <br />    expect(s).toEqual(<span style="color: #0000dd; font-weight: bold;">3</span>);<br />    });<br />});<br /></pre></td></tr></tbody></table></div><br /><br />'<b>expect</b>' is equivalent to '<b>assert</b>' and '<b>toEqual</b>' is the matcher.<br />Let's spice this up a little bit. Say, we validate the input params (num1 &amp; num2) before returning the sum<br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: .1em .1em .1em .8em; border: solid gray; overflow: auto; padding: .2em .6em; width: auto;"><table><tbody><tr><td><pre style="line-height: 125%; margin: 0;"> 1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10<br />11</pre></td><td><pre style="line-height: 125%; margin: 0;"><span style="color: #008800; font-weight: bold;">function</span> sum(num1, num2){<br />    <span style="color: #008800; font-weight: bold;">var</span> isValid <span style="color: #333333;">=</span> validateParams(num1,num2);<br />    <span style="color: #008800; font-weight: bold;">if</span>(isValid)<br />        <span style="color: #008800; font-weight: bold;">return</span> num1<span style="color: #333333;">+</span> num2;<br />    <span style="color: #008800; font-weight: bold;">else</span><br />        <span style="color: #008800; font-weight: bold;">return</span> <span style="color: #333333;">-</span><span style="color: #0000dd; font-weight: bold;">1</span>;<br />}<br /><span style="color: #008800; font-weight: bold;">function</span> validateParams(num1,num2)<br />{<br /> <span style="color: #888888;">// some logic</span><br />}<br /></pre></td></tr></tbody></table></div><br />Now, what if the validateParams function fails when testing the sum function? We are not bothered about the functionality of the validateParams function when testing the sum function right? All we need is the function to return true/false based on then input so that the sum function can go ahead and do its job. So why not mock the function validateParams? <br /><br />Jasmine provides a way to spy on functions. No matter how the validateParams function works, we would still be able to test the sum function.<br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: .1em .1em .1em .8em; border: solid gray; overflow: auto; padding: .2em .6em; width: auto;"><table><tbody><tr><td><pre style="line-height: 125%; margin: 0;"> 1<br /> 2<br /> 3<br /> 4<br /> 5<br /> 6<br /> 7<br /> 8<br /> 9<br />10<br />11<br />12<br />13<br />14</pre></td><td><pre style="line-height: 125%; margin: 0;">describe(<span style="background-color: #fff0f0;">"this is a suite"</span>, <span style="color: #008800; font-weight: bold;">function</span>() {<br />    it(<span style="background-color: #fff0f0;">"this is a spec where validateParams returns true"</span>, <span style="color: #008800; font-weight: bold;">function</span>() {<br />    <span style="color: #008800; font-weight: bold;">var</span> fakeValidateParams <span style="color: #333333;">=</span> jasmine.createSpy();<br />spyOn(<span style="color: #007020;">window</span>,<span style="background-color: #fff0f0;">'validateParams'</span>).andReturn(<span style="color: #008800; font-weight: bold;">true</span>);<br />    <span style="color: #008800; font-weight: bold;">var</span> s <span style="color: #333333;">=</span> sum(<span style="color: #0000dd; font-weight: bold;">1</span>,<span style="color: #0000dd; font-weight: bold;">2</span>);       <br />    expect(s).toEqual(<span style="color: #0000dd; font-weight: bold;">3</span>);<br />    });<br />    it(<span style="background-color: #fff0f0;">"this is a spec where validateParams returns false"</span>, <span style="color: #008800; font-weight: bold;">function</span>() {<br />    <span style="color: #008800; font-weight: bold;">var</span> fakeValidateParams <span style="color: #333333;">=</span> jasmine.createSpy();<br />spyOn(<span style="color: #007020;">window</span>,<span style="background-color: #fff0f0;">'validateParams'</span>).andReturn(<span style="color: #008800; font-weight: bold;">false</span>);   <br />    <span style="color: #008800; font-weight: bold;">var</span> s <span style="color: #333333;">=</span> sum(<span style="color: #0000dd; font-weight: bold;">1</span>,<span style="color: #0000dd; font-weight: bold;">2</span>);       <br />    expect(s).toEqual(<span style="color: #333333;">-</span><span style="color: #0000dd; font-weight: bold;">1</span>);<br />    });<br />});<br /></pre></td></tr></tbody></table></div><br />This way, its easier to fake ajax calls, spy on library functions. I have put together a simple login app with bare minimum javascript. It's integrated with maven and the specs can be run as a part of your build without having to make use of the browser. <br /><br />Jasmine, through the <a href="https://github.com/velesin/jasmine-jquery">jasmine-jquery plugin</a> also lets you use json fixtures to test functions which take inputs. <br /><br /><a href="https://github.com/velesin/jasmine-jquery#json-fixtures">getJSONFixture(*.json)</a> - loads the json data and makes it available for your specs. By default, fixtures are loaded from this location - <br /><br />spec/javascripts/fixtures/json. <br /><br />Jasmine has a lot more to offer, with support to fake events, fake timers etc. Do read the <a href="http://pivotal.github.io/jasmine/">documentation</a>. <br /><br /><u><b>Steps</b></u>:<br /><br />1. Clone the project from <a href="https://github.com/karthikch53/jasmine_js_unit_testing">github</a>.<br />2. Navigate to the path where you find pom.xml (pom.xml is configured with jasmine-maven-plugin and the saga-maven-plugin to generate coverage report)<br />3. Run "<b>mvn clean test</b>" to run the specs and "<b>mvn clean verify</b>" to run the specs &amp; generate the coverage report.<br />4. Open the total-report.html and see the magic unfold in front your eyes ;-)<br /><br />Jasmine specs run from the terminal <br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-NQp0UWJXBDU/Ur7sZAuIOFI/AAAAAAAABCI/n5xI8gwnNhQ/s1600/test-specs.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="179" src="http://1.bp.blogspot.com/-NQp0UWJXBDU/Ur7sZAuIOFI/AAAAAAAABCI/n5xI8gwnNhQ/s320/test-specs.png" width="320" /></a></div><br />Coverage Report<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-G6WQSwOxIYs/Ur7nuuk6k4I/AAAAAAAABB8/S8toH7r3f2k/s1600/coverage-report.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="154" src="http://3.bp.blogspot.com/-G6WQSwOxIYs/Ur7nuuk6k4I/AAAAAAAABB8/S8toH7r3f2k/s320/coverage-report.png" width="320" /></a></div><br /><br /><u><b>To conclude</b></u> :<br /><br />Although, I ended up writing unit test cases for two whole modules, there was nothing conclusive about these tests. Yeah! Agreed that these tests help you test the flow. Which block of code gets called for what kind of input sort of way but that is all about it. <br />I had to do quite a bit of refactoring to make the already existing javascript functions testable. <br />Similar opinions expressed on this <a href="http://stackoverflow.com/questions/18076268/what-should-i-write-unit-tests-for-in-jasmine">stackoverflow link</a> as well. <br /><br />Do let me know what you think.<br /><br />PS: Title courtesy - <a href="http://nathanleclaire.com/blog/2013/12/13/how-to-unit-test-controllers-in-angularjs-without-setting-your-hair-on-fire/">This Post</a> </div>
<br>
<br>

<a href="/tag/jasmine-maven/index.html" rel="tag">jasmine-maven</a>

<a href="/tag/jasmine_saga_plugin/index.html" rel="tag">jasmine_saga_plugin</a>

<a href="/tag/jasmine-jquery/index.html" rel="tag">jasmine-jquery</a>

<a href="/tag/unit_testing/index.html" rel="tag">unit_testing</a>

<a href="/tag/jasmine/index.html" rel="tag">jasmine</a>

<a href="/tag/code_coverage/index.html" rel="tag">code_coverage</a>

<a href="/tag/javascript/index.html" rel="tag">javascript</a>

<a href="/tag/json_fixtures/index.html" rel="tag">json_fixtures</a>



    </main><footer>
  
</footer>
</div>
  </body>
</html>
