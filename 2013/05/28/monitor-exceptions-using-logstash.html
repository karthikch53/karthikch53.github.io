<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Monitor exceptions using logstash</title><link rel="stylesheet" type="text/css" href="/assets/main-light.css"></head>
<body>
    <div class="container"><header>
  <div class="menu">
    <ul><li><a href="/">/home</a></li><li><a href="/about/">/about</a></li></ul>
  </div>
</header>
<main>
      <b>Monitor exceptions using logstash</b>
<br>
<br>
<div dir="ltr" style="text-align: left;" trbidi="on"><div style="margin-bottom: 0in;">Continued : <a href="http://root-node-001.blogspot.in/2013/05/logstash-getting-started.html">Logstash getting started</a> </div><div style="margin-bottom: 0in;"><br />To monitor exceptions, we are going to need a little more than grep. Replace the filter section of the test.conf file attached in the previous post with this.</div><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: .1em .1em .1em .8em; border: solid gray; overflow: auto; padding: .2em .6em; width: auto;"><pre style="line-height: 125%; margin: 0;">filter { <br /><br /> multiline {<br />                patterns_dir =&gt; "D:/logstash/logstash-1.1.9-monolithic/patterns"<br />                pattern =&gt; "^(%{MONTH}|%{YEAR}-)"<br />                negate =&gt; true<br />                what =&gt; "previous"<br />                type =&gt; "loglevel"<br />        }<br /><br /> grok {<br />                patterns_dir =&gt; "D:/logstash/logstash-1.1.9-monolithic/patterns"<br />                pattern =&gt; ["(?m)(?&lt;logdate&gt;%{MONTH} %{MONTHDAY}, %{YEAR} %{DATA} [AP]{1}M{1}) %{NOTSPACE:package} %{WORD:method}.*%{LOGLEVEL:loglevel}: %{GREEDYDATA:msg}"]<br />                singles =&gt; true<br />                <br />        }<br /> <br /> grep {<br />               # Answers the question - what are you looking for? <br />               # In this example, I am interested in server start up. <br />               # @message - maps to one log statement/event and I have defined a grep to match the word <br />               # 'Server startup' in the message.<br />               match =&gt; ["@message","<b><span style="color: blue;">CannotLoadBeanClassException</span></b>"]               <br />               type =&gt; "loglevel"<br />         }<br />}<br /></pre></div><div style="margin-bottom: 0in;"><br /></div><div style="margin-bottom: 0in;"><br /></div><div style="margin-bottom: 0in;">Grep matches a word in a line (<b><span style="color: blue;">CannotLoadBeanClassException</span></b>) but we need a bit more when it comes to getting the exception stack trace, isn't it?</div><div style="margin-bottom: 0in;">Fret not. Logstash's <a href="http://logstash.net/docs/1.1.12/filters/multiline">multiline</a> to the rescue. Multiline uses Grok pattern to identify a pattern.<br /><br />More about Grok filters &gt;&gt; <a href="http://logstash.net/docs/1.1.12/filters/grok">Here</a></div><div style="margin-bottom: 0in;"></div><div style="margin-bottom: 0in;"><br /></div><div style="margin-bottom: 0in;">My tomcat logs are in this format: </div><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: .1em .1em .1em .8em; border: solid gray; overflow: auto; padding: .2em .6em; width: auto;"><pre style="line-height: 125%; margin: 0;">May 28, 2013 6:04:30 PM org.apache.catalina.core.StandardContext startInternal<br />SEVERE: Error listenerStart<br /></pre></div><div style="margin-bottom: 0in;"><br /></div><div style="margin-bottom: 0in;"><span style="color: blue;">pattern =&gt; "^(%{MONTH}|%{YEAR}-)"</span>indicates that any line that begins in this format is a part of the multi line event. So, technically, every line in our log file is a part of the multi line event.</div><div style="margin-bottom: 0in;"><span style="color: blue;">negate =&gt; true</span></div><div style="margin-bottom: 0in;">When negate is set to true the lines which doesn't match (line 101-119) the given pattern will be constituted as a part of the multi line filter and will subsequently be added to the previously encountered line which matches the pattern.(line 100) Phew.! ;-)</div><div style="margin-bottom: 0in;"><br /></div><div style="margin-bottom: 0in;">For instance at line no. 100 we have a match and assume that the subsequent lines give away the stack trace. </div><div style="margin-bottom: 0in;">Line 100:: May 28, 2013 6:04:30 PM org.apache.catalina.core.StandardContext startInternal</div><div style="margin-bottom: 0in;">.................</div><div style="margin-bottom: 0in;">.................</div><div style="margin-bottom: 0in;"><i>/* A match is occurred at line 100 and the subsequent 20 lines are added to line 100. */</i></div><div style="margin-bottom: 0in;">....................</div><div style="margin-bottom: 0in;">....................</div><div style="margin-bottom: 0in;">Line 120::: May 28, 2013 6:04:30 PM org.apache.catalina.core.StandardContext stop<br /><br />This way, we will get the entire stack trace. <br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-7W1haCzIcbw/UaSveKIbskI/AAAAAAAAA0I/x9k4DO7-xxw/s1600/L2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="200" src="http://1.bp.blogspot.com/-7W1haCzIcbw/UaSveKIbskI/AAAAAAAAA0I/x9k4DO7-xxw/s320/L2.png" width="320" /></a></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-zaZPo0djYSY/UaSvgBirYWI/AAAAAAAAA0Q/fuagOFjLB8o/s1600/L3.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="129" src="http://3.bp.blogspot.com/-zaZPo0djYSY/UaSvgBirYWI/AAAAAAAAA0Q/fuagOFjLB8o/s320/L3.png" width="320" /></a></div><br />Now that we have the stack trace&nbsp; with us, its just a matter of configuring the appropriate output.&nbsp; <br />&nbsp;Send the message via <a href="http://logstash.net/docs/1.1.12/outputs/email">Email</a> or Invoke a <a href="http://logstash.net/docs/1.1.12/outputs/http">HTTP</a> endpoint<br /><br />As <a href="https://plus.google.com/u/0/102174395420110588214/posts">Sridhar</a> pointed out, there should be an option for the users to subscribe for a specific exception rather being spammed with all exception stack traces. <br /><br /><!-- HTML generated using hilite.me --><br /><div style="background: #ffffff; border-width: .1em .1em .1em .8em; border: solid gray; overflow: auto; padding: .2em .6em; width: auto;"><pre style="line-height: 125%; margin: 0;"># Define grep blocks for the exceptions that you want to monitor and as<br /># when there is a match you can add certain feilds and use them later<br /><br />grep {<br />               match =&gt; ["@message","<span style="color: blue;">NullPointerException</span>"]<br />               add_field =&gt; ["exception_message", "Exception message - %{@message}"]            <br />        add_field =&gt; ["exception_subject","NullpointerException occurred"]<br />               add_field =&gt; ["recipients_email","<span style="color: blue;">johnDoe@gmail.com</span>"]<br />        type =&gt; "loglevel"<br />     }<br />  <br />grep {<br />        match =&gt; ["@message","<span style="color: #38761d;">IndexOutOfBoundsException</span>"]<br />        add_field =&gt; ["exception_message", "Exception message - %{@message}"]            <br />        add_field =&gt; ["exception_subject","IndexOutOfBoundsException occurred...."]<br />        add_field =&gt; ["recipients_email","<span style="color: #38761d;">janeDoe@gmail.com</span>"]<br />        type =&gt; "loglevel"<br />}<br /><br /># This way, you can customize the message sent for each exception.<br /># again, recipients, subject and message are json attributes.</pre><pre style="line-height: 125%; margin: 0;"># Url points to the http end point which takes care of sending out mails. </pre><pre style="line-height: 125%; margin: 0;">&nbsp;http {<br />    content_type =&gt; "application/json"       <br />    format =&gt; "json"    <br />    http_method =&gt; "post"</pre><pre style="line-height: 125%; margin: 0;">    url =&gt; "http://localhost:8080/services/notification/email"</pre><pre style="line-height: 125%; margin: 0;">&nbsp;   mapping =&gt; ["recipients","%{recipients_email}","subject","%{exception_subject}","message","%{exception_message}"]      <br />    type =&gt; "loglevel"<br />  }<br /></pre></div></div><div style="margin-bottom: 0in;"></div><div style="margin-bottom: 0in;"><br />And if there are n-number of exceptions that you need to monitor you can define them in separate conf files&nbsp; and provide the folder as input during logstash start up using <a href="http://www.logstash.net/docs/1.1.12/flags">logstash's command line flags</a>. That way, it ll be easier to maintain the conf files. One file for every exception might be an overkill but how about one conf file per module? <br /><br />Makes sense? B-)<br /><br />Do let me know if you try this out. <br /><br />Happy Coding :)<br />~ cheers.!</div></div>
<br>
<br>

<a href="/tag/j2ee/index.html" rel="tag">j2ee</a>

<a href="/tag/logstash_multiline/index.html" rel="tag">logstash_multiline</a>

<a href="/tag/exception_handling/index.html" rel="tag">exception_handling</a>

<a href="/tag/logstash/index.html" rel="tag">logstash</a>

<a href="/tag/java/index.html" rel="tag">java</a>



    </main><footer>
  
</footer>
</div>
  </body>
</html>
